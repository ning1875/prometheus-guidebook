



#  <font color=blue> 大运维平台5大模块</font>
- 01 资产管理 & cmdb & 服务树
- 02 工单 & 工作流 & 审批
- 03 cicd 全流程配置
- 04 Prometheus管理配置
- 05 k8s多集群管理

##  <font color=red>00 为什么是这5个模块</font>
- k8s/prometheus/cicd作为当下3大运维开发主流方向，这点大家都知道
- 但是如果只做上面3个模块还少了些基础的模块
- 这里的基础模块说的就是 cmdb和工单
- cmdb很好理解：
    - 监控/cicd/k8s等内部很多资源都属于资源
    - 资源就需要有管理的地方
    - 同时资产和服务的绑定形式应该是一颗服务树
    - 在服务树的节点上可以配置权限和绑定其他模块资源
        - 比如给 data.system.dns 绑定cicd发布模板可以发布dns配置
        - 比如给 infra.sre.apolloy绑定监控告警配置项
- 那么为什么还需要工单呢，主要原因有下面2点
    - 01 因为我们很多的操作需要工单审批之后才做
        - 比如 在页面上通过yaml编辑器编辑 k8s的deployment 会触发变更
        - 此时应该触发生成一张工单：经过预设的审批人审批后 再执行
    - 02 还有一些我们通用的运维工作需要工单支持
        - 比如调整安全组
        - 比如申请consul 服务发现token

## 树层级 总结服务树前端功能
- 每个树层级操作

    - 展开和折叠:
        - 默认只展开第一层
        - 每次点击下一层的展开按钮再展开 ：infra.k8s.prod-01.node.k8s-node-prod-01
    - 这个树节点内容：获取这个节点的机器列表

- 加载方式
    - 懒加载 异步  D:\nyy_work\fe-work\a-ben-yuan\src\views\demo\tree\index.vue
        - 数据不是一次请求完成
        - 而且根据父级再去查询子集
- 数据操作 ：右键菜单 beforeRightClick
    - 在父层级添加子集
    - 删除
- 工具栏使用 toolbar
- 函数操作按钮 D:\nyy_work\fe-work\a-ben-yuan\src\views\demo\tree\ActionTree.vue
- isLeaf 叶子节点：不能再有孩子了
- showLine 节点连线

## 服务树
- 服务树节点操作
    - 增加：右键添加
        - 父层级添加子层级
        - 节点属性：
            - 名称        name
            - 是否是子节点 isLeaf
            - 第几层级：  0,1,2,3
            - 父节点id：  parentId
            - 图标：      icon ：选择列表，而不是五花八门的
    - 删除：右键删除
        - 是否级联删除
        - 删除保护：如果子节点还有，那么不让删除父节点
    - 更新：根据id操作
        - 名称是可以更新的
    - 挪动节点？ 是否要做 ：也可以通过先删除后添加
- 树展示：查询
    - 一层一层的加载：默认全部展开是没有意义的
    - 数据是否异步：
        - 服务树特别庞大：全部数据前端渲染比较卡
        - 根据父层级查子层级：向下一层查询
        - 根据父层级展开所有层级：
- 不太想拼接 id形式 0-1-3-4


# 服务树和cmdb课程大纲
- 第1章 服务树的准备工作
  - 1.1 vben-树形结构01
  - 1.2 vben-树形结构02
  - 1.3 antd的树形结构
  - 1.4 思考服务树交互流程
  - 1.5 服务树菜单准备
  - 1.6 前端demo
  - 1.7 树形结构父子关系的问题
  - 1.8 准备下样式
  - 1.9 tree节点替换图标
  - 1.10 后端api同步获取treeData渲染

- 第2章 treeData类型非异步服务树接口实现
  - 2.1 面包屑页面缓存不再请求后端接口问题
  - 2.2 节点node的字段和ogpa模型
  - 2.3 添加顶层节点的按钮
  - 2.4 新增节点流程前端打通
  - 2.5 新增节点的后端接口
  - 2.6 查询节点拼接children列表
  - 2.7 节点唯一性原则和新增节点提示语
  - 2.8 删除节点的前端保护措施
  - 2.9 删除节点的后端保护措施

- 第3章 loadData类型异步服务树接口实现
  - 3.1 异步服务树接口实现
  - 3.2 头部打印服务树节点表示a.b.c.d后端接口
  - 3.3 头部打印服务树节点表示a.b.c.d前端展示
  - 3.4 添加基本信息
  - 3.5 调整标签页的样式
  - 3.6 节点详情字段展示
  - 3.7 联动展示
  - 3.8 修改节点信息的模态框
  - 3.9 vue3父子组件传值的问题
  - 3.10 带上form的modal

- 第4章 服务树节点和人员权限
  - 4.1 理清人员和服务节点的关系
  - 4.2 定义节点人员列表
  - 4.3 运维负责人列表编辑和请求前端
  - 4.4 后端级联更新逻辑
  - 4.5 服务树接口权限通用检查方法
  - 4.6 测试添加节点父子权限继承问题
  - 4.7 删除节点和修改节点权限
  - 4.8 服务树展示收尾工作

- 第5章 cmdb基础信息同步
  - 5.1 后面内容的展望
  - 5.2 从sdk中寻找阿里云ecs结构体
  - 5.3 设计ecs表结构
  - 5.4 GORM存取数组
  - 5.5 设计资源的公共字段
  - 5.6 同步公有云资源架构设计
  - 5.7 同步模块配置文件
  - 5.8 goroutine编排库
  - 5.9 公有云ticker同步任务
  - 5.10 workerpool并发同步内容

- 第6章 cmdb增量同步
  - 6.1 入口同步多种资源
  - 6.2 toAdd-toDel等逻辑实现
  - 6.3 mock构造数据
  - 6.4 验证随机同步
  - 6.5 验证字段变更
  - 6.6 环境公共字段

- 第7章 服务树和cmdb资源绑定
  - 7.1 增加叶子节点逻辑
  - 7.2 ecs资源绑定前端穿梭框
  - 7.3 未绑定节点ecs列表后端接口
  - 7.4 穿梭框问题修复
  - 7.5 树节点绑定ecs列表的api接口
  - 7.6 验证增量更新toDel级联删除
  - 7.7 解绑ecs资源
  - 7.8 绑定和解绑穿梭框互斥
  - 7.9 ecs数据展示表格调研
  - 7.10 ecs数据表格交互

- 第8章 服务树和cmdb资源展示
  - 8.1 查询所有树子id
  - 8.2 limit和offset逻辑
  - 8.3 排查接口panic问题
  - 8.4 前端表格展示尝试vben
  - 8.5 递归获取所有子节点
  - 8.6 表格展示和mock数据
  - 8.7 表格分页遇到问题
  - 8.8 非首次选中执行reload
  - 8.9 表格查询搜索分类
  - 8.10 节点详情展示ecs绑定数量

- 第9章 资源统计结合echarts
  - 9.1 总结下服务树的TODO
  - 9.2 echart初步整合
  - 9.3 vue3父子组件如何传递参数
  - 9.4 后端提供按标签统计的数据
  - 9.5 倒排图 图例标签
  - 9.6 ecs区域饼图
  - 9.7 重新编排后端mock数据
  - 9.8 重写递归获取所有子节点
  - 9.9 table-reload问题修复
  - 9.10 导入仪表盘

- 第10章 资源统计02
  - 10.1 总cpu总内存尝试失败
  - 10.2 echart图表随节点刷新
  - 10.3 子组件watch对象变化
  - 10.4 叶子节点数量
  - 10.5 总cpu-内存-磁盘
  - 10.6 单个vue文件3-chart图表

- 第11章 扩展其他资源：elb
  - 11.1 负载均衡器LB的sdk字段
  - 11.2 LB结构体基础字段
  - 11.3 对比nlb-alb-clb
  - 11.4 gorm基础方法
  - 11.5 nlb的ListLoadBalancers方法
  - 11.6 mock nlb的数据
  - 11.7 整理mock公共字段和独特字段
  - 11.8 资源表的公共字段
  - 11.9 elb增量更新
  - 11.10 同步资源计划任务文件拆分

- 第12章 扩展cmdb-elb-资源绑定-表格
  - 12.1 验证elb的同步
  - 12.2 elb删除前查找错误
  - 12.3 新增elb标签页
  - 12.4 一个页面中使用多次UseTable
  - 12.5 elb绑定的穿梭框
  - 12.6 穿梭框的打开关闭
  - 12.7 elb绑定的后端接口
  - 12.8 elb解绑的后端接口
  - 12.9 elb数据表格和分页
  - 12.10 elb数据表格查询

【2】服务树-cdmb 第12章 扩展cmdb-elb-资源绑定-表格
【2】服务树-cdmb 第13章 扩展cmdb-elb-统计图标
【2】服务树-cdmb 第14章 扩展其他资源：rds
【2】服务树-cdmb 第8-14章资源展示绑定统计ecs rds elb

- 第13章 扩展cmdb-elb-统计图标
  - 13.1 elb-统计图标基础
  - 13.2 elb后端统计方法
  - 13.3 前端chart数据对齐
  - 13.4 调整服务树节点资源统计汇总

- 第14章 扩展其他资源：rds
  - 14.1 关系型数据库的sdk字段
  - 14.2 gorm方法和mock数据
  - 14.3 增量同步并验证结果
  - 14.4 绑定穿梭框
  - 14.5 后端绑定和解绑的逻辑
  - 14.6 前端表格展示
  - 14.7 表格搜索
  - 14.8 rds统计chart
  - 14.9 调整echart坐标轴样式
  - 14.10 表格tags列表颜色展示



# 资源本身的管理
- 多个资源表：ecs 、rds、elb、domain、
- 字段兼顾多种公有云：以阿里云为主
    - https://help.aliyun.com/zh/ecs/developer-reference/overview-14#concept-25699-zh
    - https://github.com/aliyun/alibaba-cloud-sdk-go/blob/master/README.md
- 物理机字段
- 应该按照命名规范 进行资源和服务树绑定  g-p-a-env
- 资源上应该添加必备的元信息标签：方便做资源主动统计
    - 如 a.b.c 有多少 多个 机器 lb  rds
    - 按region cluster 公有云厂商区分

# 资源录入
- 不支持页面录入
- 比如通过 同步公有云或者 agent信息上报实现

## 存量资源如何录入系统
- 基于公有云的增量信息同步
    - 元信息算 hash ，计算to_add to_del to_mod set
- 基于agent-grpc信息上报

## 增量信息录入主要来自工单

# 服务树和资源绑定 资源以机器举例 ：注意分为2点 ：资源的录入和 绑定

## 01 后端逻辑
- 机器表和树表如何关联: 在资源表上添加tree_node多对多字段，对应树叶子节点id
- fetchResourceByNode: 如何查询父级节点下的资源:
    - 比如查询sys.data
    - 先遍历tree拿到它所有的叶子节点id数组
    - 再根据id找到对应资源即可
- 多对多意味着 资源可以绑定到多个节点
    - 允许混布

## 02 前端功能
- 在树叶子节点上点击 绑定资源
    - 选择穿梭框：默认拉取未绑定过的节点
    - 后端提供 bind接口
        - 资源类型
        - 资源元信息 只提供 name或者id即可
        - 服务树节点 ：比如 给 a.b.c 绑定3个机器 1.1.1.{1,3}
        - 资源应该先录入系统：然后进行绑定即可
- 有绑定就有 解绑：原理一致 也采用穿梭框 ：拉取当前已经绑定机器
    - 后端对应 对应的树节点id从 资源的tree_node多对多 中删除
- 这里带来一个问题：叶子节点和非叶子节点的右键 按钮列表应该不一样 ：新增节点时需要标记是否为叶子节点
    - 叶子节点：
        - 删除节点
        - 绑定资源
        - 解绑资源
    - 非叶子节点：
        - 删除节点
        - 增加节点
- 资源绑定的按钮位置：这里也可以选择 在选中节点后再 做绑定
- 统一申请资源入口：资源申请工单
    - 如机器如何和服务树绑定，新申请机器提工单 绑定服务树 提供主机名
    - 调用公有云接口进行购买
    - 或者 物理机房的资源申请

# 基于服务树和机器可以做 批量任务执行功能
- 权限：在树节点上选择：是运维负责人即可

# 获取一个人 有权限的服务树节点列表，只需根据user找到tree_id，然后进行父级拼接即可







# 工单系统
- https://github.com/lanyulei/ferry
- 工单审核
- 工单执行：server端内部代码，固定逻辑
- 流程管理：自定义表单
  - 存储的是大段 json
  - 重点是谁来执行，应该是 workflow类似的脚本

## 01 设计工单
- 工单的form 自定义
- 表单设计 
- 工单的审批流
- 工单的执行
- 


# 工作流系统 https://github.com/go-workflow/go-workflow
- 可以理解为原本 一个post请求 购买机器
  - 现在变成必须要 经过审批流后才能到达 api接口处理
  - 最终也是发送 json数据给api接口
- 流程代表不同的工单类型
  - 相当于可以设计 form表单都要填什么字段
  - 可以设计 审批步骤
- 流程的实例化就是 指定工单类型创建工单
- 流程 样例 https://github.com/go-workflow/go-workflow/blob/master/EXAMPLE.md





